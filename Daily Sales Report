//Global Variables
var mainSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Charts & Daily Summary");
var secondSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Data Summary");
var magSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Sheet1");
var fileLink = SpreadsheetApp.getActiveSpreadsheet().getUrl();
var retailSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Retail Sales");

/* Will be used for additional HTML Tables
var kc_range = mainSheet.getRange("L2:N7");
var fit_range = mainSheet.getRange("L2:N7");
var web_range = mainSheet.getRange("L2:N7");
var ret_range = mainSheet.getRange("L2:N7");
*/

var kc_chart= mainSheet.getCharts()[3];
var fit_chart = mainSheet.getCharts()[2];
var website_chart = mainSheet.getCharts()[0];
var ret_chart = mainSheet.getCharts()[1];

var date_formula = magSheet.getRange("I2").getFormula();
var formula_row_count = magSheet.getLastRow()-1;
var chartRanges = mainSheet.getCharts()[3].getRanges();
var chart_row_count = secondSheet.getLastRow();
var retail_row = retailSheet.getLastRow();

function sendEmail() {

  var kc_chart_img = mainSheet.getCharts()[3].getAs(MimeType.PNG);
  var fit_chart_img = mainSheet.getCharts()[2].getAs(MimeType.PNG);
  var website_chart_img = mainSheet.getCharts()[0].getAs(MimeType.PNG);
  var ret_chart_img = mainSheet.getCharts()[1].getAs(MimeType.PNG);

  GmailApp.sendEmail("exec@killcliff.com", "Daily Sales Digest", "", {
  from: "omar@killcliff.com",
  name: "Kill Cliff Insights",
  htmlBody: 'Please note: Fitness and Website sales might vary slightly between 8pm and 12am due to server timezones; Retail sales are added based on emails flowing through PO@killcliff.com (will update to include unshipped items). <br/> Below are snapshots of our performance over the specified time period. If you would like to view the spreadsheet behind these images, please visit: ' + fileLink + '.<br/><img src="cid:kcImage"><br/><img src="cid:fitImage">,<br/><img src="cid:webImage"><br/><img src="cid:retImage">',
  inlineImages: {
    kcImage: kc_chart_img,
    fitImage: fit_chart_img, 
    webImage: website_chart_img,
    retImage: ret_chart_img }
});

  
}

function formulaUpdate() {

  magSheet.getRange(2, 9, formula_row_count).setFormula(date_formula);

}

function newRow () {

var new_row_formula = secondSheet.getRange(chart_row_count, 1, 1,6).copyTo(secondSheet.getRange(chart_row_count+1, 1));
secondSheet.getRange(chart_row_count, 5).setValue(0); 

}

function retailSales () {

//search gmail for messages from grace
var mailSearch = GmailApp.search('from:"grace@killcliff.com" to: "purchaseorders@killcliff.com" +Total order value');
var mailMessage = mailSearch[0].getMessages()[0];
var mailBody = mailMessage.getPlainBody();
var mailDate = mailMessage.getDate();
var mailId = mailMessage.getId();
//find 'Total order value: $xxx.xx'
var $sign = mailBody.indexOf("$");
var period = mailBody.indexOf(".");
var arr = [];
//extract $xxx.xx
var total = mailBody.substr($sign + 1, (period - $sign) + 2);

if (mailId != retailSheet.getRange(retail_row, 4).getValue()) {

total.trim();
retailSheet.getRange(retail_row + 1, 1).setValue(mailDate);
//add to sheet
retailSheet.getRange(retail_row + 1, 2).setValue(total);
//update formula
retailSheet.getRange(retail_row, 3).copyTo(retailSheet.getRange(retail_row + 1, 3));
retailSheet.getRange(retail_row + 1, 4).setValue(mailId);

} 

}







